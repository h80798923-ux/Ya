name: Build TrixieOs ISO (robust)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies (full, safe)
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex \
          libncurses-dev libssl-dev libelf-dev libdw-dev binutils-dev \
          wget tar gzip xz-utils bzip2 cpio rsync file \
          xorriso grub-pc-bin grub-common mtools

    - name: Prepare workspace
      run: |
        rm -rf rootfs iso vmlinuz initrd.img initramfs.img initrd.img TrixieOs.iso
        mkdir -p rootfs iso/boot/grub rootfs/boot rootfs/bin rootfs/sbin rootfs/usr/bin

    # ---------------- ROOTFS (bootstrap - hidden) ----------------
    - name: Bootstrap base rootfs (hidden)
      run: |
        wget -q https://dl-cdn.alpinelinux.org/alpine/v3.19/releases/x86_64/alpine-minirootfs-3.19.1-x86_64.tar.gz
        sudo tar -xzf alpine-minirootfs-3.19.1-x86_64.tar.gz -C rootfs

        # ensure ownership so we can modify files
        sudo chown -R $USER:$USER rootfs

        # remove visible alpine traces and apk DB locks (safe removal)
        sudo rm -f rootfs/etc/alpine-release
        sudo rm -f rootfs/lib/apk/db/lock || true
        sudo rm -rf rootfs/etc/apk || true

    # ---------------- OS IDENTITY ----------------
    - name: Set /etc/os-release to TrixieOs
      run: |
        cat > rootfs/etc/os-release <<'EOF'
        NAME="TrixieOs"
        ID=trixieos
        PRETTY_NAME="TrixieOs"
        VERSION="1.0"
        VERSION_ID="1.0"
        HOME_URL="https://trixieos.local"
        EOF
        echo "TrixieOs ProjectA tarafından yapıldı" > rootfs/etc/issue
        echo "Welcome to TrixieOs" > rootfs/etc/motd

    # ---------------- TRX (apk gizleme safe) ----------------
    - name: Create trx wrapper and hide apk safely
      run: |
        # move apk if present (safe)
        if [ -f rootfs/sbin/apk ]; then
          sudo mv rootfs/sbin/apk rootfs/sbin/.apk.real || true
        fi

        # place trx wrapper
        cat > rootfs/usr/bin/trx <<'EOF'
        #!/bin/sh
        echo "TrixieOs Package Manager (trx) - wrapper"
        exec /sbin/.apk.real "$@"
        EOF
        sudo chmod +x rootfs/usr/bin/trx

        # ensure apk command (if invoked) forwards to trx (if .apk.real exists)
        cat > rootfs/sbin/apk <<'EOF'
        #!/bin/sh
        exec /usr/bin/trx "$@"
        EOF
        sudo chmod +x rootfs/sbin/apk || true

    # ---------------- BUSYBOX (reliable, no-jobs, warnings suppressed) ----------------
    - name: Build BusyBox (stable, single-threaded, warnings suppressed)
      run: |
        wget -q https://busybox.net/downloads/busybox-1.36.1.tar.bz2
        tar -xjf busybox-1.36.1.tar.bz2
        cd busybox-1.36.1

        # generate default config
        make defconfig

        # disable heavier/fragile features that trigger long compile or problematic warnings
        sed -i 's/CONFIG_I2C_TOOLS=y/CONFIG_I2C_TOOLS=n/' .config || true
        sed -i 's/CONFIG_IFUPDOWN=y/CONFIG_IFUPDOWN=n/' .config || true
        sed -i 's/CONFIG_FEATURE_IFCONFIG_STATUS=y/CONFIG_FEATURE_IFCONFIG_STATUS=n/' .config || true

        # compile single-threaded and suppress format-truncation warnings
        make CFLAGS="-O2 -Wno-format-truncation" V=0

        # install into rootfs reliably
        sudo make CONFIG_PREFIX=../rootfs install

        # ensure /bin/sh and /init exist and point to busybox
        sudo ln -sf /bin/busybox rootfs/bin/sh
        sudo ln -sf /bin/busybox rootfs/init
        sudo chmod +x rootfs/init

    # ---------------- KERNEL (conservative build to avoid objtool fails) ----------------
    - name: Build Linux kernel (conservative)
      run: |
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.8.tar.xz
        tar -xf linux-6.6.8.tar.xz
        cd linux-6.6.8

        # baseline config
        make defconfig

        # enable essentials for initramfs & devtmpfs to avoid runtime panics
        scripts/config --enable BLK_DEV_INITRD || true
        scripts/config --enable DEVTMPFS || true
        scripts/config --enable DEVTMPFS_MOUNT || true
        scripts/config --enable TMPFS || true
        scripts/config --disable DEBUG_INFO || true

        # refresh config
        make olddefconfig

        # single-threaded to reduce resource spikes on runner (safer)
        make -j1

        # copy kernel image to top level for packaging
        sudo cp arch/x86/boot/bzImage ../vmlinuz || sudo cp arch/x86/boot/bzImage ../vmlinuz

        # optionally install modules to rootfs (safer to skip heavy modules; here we skip modules_install)
        echo "Kernel build finished"

    # ---------------- INIT SCRIPT ----------------
    - name: Ensure init script (robust)
      run: |
        cat > rootfs/init <<'EOF'
        #!/bin/sh
        mount -t proc proc /proc || true
        mount -t sysfs sysfs /sys || true
        mount -t devtmpfs devtmpfs /dev || true
        echo "TrixieOs ProjectA tarafından yapıldı"
        echo "Paket yöneticisi: trx"
        exec /bin/sh
        EOF
        sudo chmod +x rootfs/init
        sudo chown root:root rootfs/init

    # ---------------- CLEANUP (locks, perms) ----------------
    - name: Cleanup locks & fix permissions
      run: |
        sudo rm -f rootfs/lib/apk/db/lock || true
        sudo chmod -R u+rwX rootfs || true

    # ---------------- BUILD INITRAMFS ----------------
    - name: Build initramfs (newc, owner root)
      run: |
        cd rootfs
        sudo find . -print0 | sudo cpio --null -ov --format=newc --owner=root:root | gzip > ../initrd.img
        sudo chown $USER:$USER ../initrd.img || true

    # ---------------- PREPARE ISO TREE ----------------
    - name: Prepare ISO tree and grub config
      run: |
        mkdir -p iso/boot/grub
        cp vmlinuz iso/boot/vmlinuz
        cp initrd.img iso/boot/initrd.img

        cat > iso/boot/grub/grub.cfg <<'EOF'
        set timeout=5
        set default=0

        menuentry "TrixieOs" {
          echo "TrixieOs ProjectA tarafından yapıldı"
          linux /boot/vmlinuz init=/init
          initrd /boot/initrd.img
        }
        EOF

    # ---------------- BUILD ISO (handles xorriso/mtools) ----------------
    - name: Build bootable ISO
      run: |
        # ensure no stale apk lock remains
        sudo rm -f rootfs/lib/apk/db/lock || true
        chmod -R u+rwX rootfs || true

        # produce ISO
        grub-mkrescue -o TrixieOs.iso iso

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: TrixieOs-ISO
        path: TrixieOs.iso
