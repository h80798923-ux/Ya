name: Build TrixieOs ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          wget tar gzip xz-utils \
          cpio xorriso \
          grub-pc-bin grub-common \
          mtools \
          libelf-dev

    - name: Prepare rootfs
      run: |
        sudo mkdir -p rootfs
        wget https://dl-cdn.alpinelinux.org/alpine/v3.19/releases/x86_64/alpine-minirootfs-3.19.1-x86_64.tar.gz
        sudo tar -xzf alpine-minirootfs-3.19.1-x86_64.tar.gz -C rootfs

    - name: Set TrixieOs os-release
      run: |
        sudo rm -f rootfs/etc/os-release
        cat << 'EOF' | sudo tee rootfs/etc/os-release
        NAME="TrixieOs"
        ID=trixieos
        PRETTY_NAME="TrixieOs"
        VERSION="1.0"
        VERSION_ID="1.0"
        HOME_URL="https://github.com/ProjectA/TrixieOs"
        EOF

    - name: Set boot messages
      run: |
        echo "TrixieOs ProjectA tarafından yapıldı" | sudo tee rootfs/etc/issue
        echo "Welcome to TrixieOs" | sudo tee rootfs/etc/motd

    - name: Prepare ISO structure
      run: |
        mkdir -p iso/boot/grub
        sudo cp -a rootfs iso/rootfs

        cat << 'EOF' > iso/boot/grub/grub.cfg
        set timeout=5
        set default=0

        menuentry "TrixieOs" {
            echo "TrixieOs ProjectA tarafından yapıldı"
            linux /boot/vmlinuz quiet
            initrd /boot/initrd.img
        }
        EOF

        # Dummy kernel/initrd (boot test için)
        dd if=/dev/zero of=iso/boot/vmlinuz bs=1M count=5
        dd if=/dev/zero of=iso/boot/initrd.img bs=1M count=5

    - name: Build ISO
      run: |
        grub-mkrescue -o TrixieOs.iso iso

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: TrixieOs-ISO
        path: TrixieOs.iso
