name: Build TrixieOs ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ---------------- DEPENDENCIES ----------------
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex \
          libncurses-dev libssl-dev libelf-dev \
          wget tar gzip xz-utils \
          cpio xorriso rsync \
          grub-pc-bin grub-common \
          mtools

    # ---------------- ROOTFS BOOTSTRAP ----------------
    - name: Bootstrap minimal rootfs
      run: |
        sudo mkdir -p rootfs
        wget https://dl-cdn.alpinelinux.org/alpine/v3.19/releases/x86_64/alpine-minirootfs-3.19.1-x86_64.tar.gz
        sudo tar -xzf alpine-minirootfs-3.19.1-x86_64.tar.gz -C rootfs

    # ---------------- IDENTITY ----------------
    - name: Set TrixieOs identity
      run: |
        sudo rm -f rootfs/etc/os-release
        cat << 'EOF' | sudo tee rootfs/etc/os-release
        NAME="TrixieOs"
        ID=trixieos
        PRETTY_NAME="TrixieOs"
        VERSION="1.0"
        VERSION_ID="1.0"
        EOF

        echo "TrixieOs ProjectA tarafından yapıldı" | sudo tee rootfs/etc/issue
        echo "Welcome to TrixieOs" | sudo tee rootfs/etc/motd

    # ---------------- BUSYBOX ----------------
    - name: Build BusyBox (static)
      run: |
        wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
        tar xf busybox-1.36.1.tar.bz2
        cd busybox-1.36.1
        make defconfig
        sed -i 's/# CONFIG_STATIC is not set/CONFIG_STATIC=y/' .config
        make -j$(nproc)
        sudo make CONFIG_PREFIX=../rootfs install

        # ZORUNLU SYMLINKLER (panic önleyici)
        sudo ln -sf /bin/busybox rootfs/bin/sh
        sudo ln -sf /bin/busybox rootfs/init

    # ---------------- KERNEL ----------------
    - name: Build Linux kernel (panic-safe)
      run: |
        wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.8.tar.xz
        tar xf linux-6.6.8.tar.xz
        cd linux-6.6.8

        make defconfig

        # PANIC ÖNLEYİCİ AYARLAR
        scripts/config --enable CONFIG_DEVTMPFS
        scripts/config --enable CONFIG_DEVTMPFS_MOUNT
        scripts/config --enable CONFIG_TMPFS
        scripts/config --enable CONFIG_BLK_DEV_INITRD
        scripts/config --disable CONFIG_DEBUG_INFO

        make olddefconfig
        make -j$(nproc)

        sudo make INSTALL_MOD_PATH=../rootfs modules_install
        sudo cp arch/x86/boot/bzImage ../vmlinuz

    # ---------------- INIT SCRIPT ----------------
    - name: Create init script
      run: |
        cat << 'EOF' | sudo tee rootfs/init
        #!/bin/sh
        mount -t proc proc /proc
        mount -t sysfs sys /sys
        mount -t devtmpfs dev /dev
        echo "TrixieOs ProjectA tarafından yapıldı"
        exec /bin/sh
        EOF
        sudo chmod +x rootfs/init

    # ---------------- PANIC & ISO FIXES ----------------
    - name: Cleanup and permissions
      run: |
        sudo rm -f rootfs/lib/apk/db/lock || true
        sudo chmod -R u+rwX rootfs

    # ---------------- INITRAMFS ----------------
    - name: Build initramfs
      run: |
        cd rootfs
        sudo find . -print0 | sudo cpio --null -ov --format=newc --owner=root:root | gzip > ../initrd.img

    # ---------------- ISO ----------------
    - name: Prepare ISO tree
      run: |
        mkdir -p iso/boot/grub
        cp vmlinuz iso/boot/vmlinuz
        cp initrd.img iso/boot/initrd.img

        cat << 'EOF' > iso/boot/grub/grub.cfg
        set timeout=5
        set default=0

        menuentry "TrixieOs" {
            echo "TrixieOs ProjectA tarafından yapıldı"
            linux /boot/vmlinuz quiet init=/init
            initrd /boot/initrd.img
        }
        EOF

    - name: Build ISO
      run: |
        grub-mkrescue -o TrixieOs.iso iso

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: TrixieOs-ISO
        path: TrixieOs.iso
