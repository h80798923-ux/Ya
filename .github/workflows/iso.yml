name: Build TrixieOs ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential bc bison flex libssl-dev \
            libelf-dev dwarves \
            grub-pc-bin grub-common xorriso mtools \
            wget tar gzip cpio rsync

      - name: Prepare workspace
        run: |
          mkdir -p work/{bootstrap,rootfs,iso/boot/grub}

      # --- Alpine bootstrap (SADECE gerekli dosyalar) ---
      - name: Alpine bootstrap (hidden)
        run: |
          wget -q https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86_64/alpine-minirootfs-3.23.2-x86_64.tar.gz
          sudo tar -xzf alpine-minirootfs-3.23.2-x86_64.tar.gz -C work/bootstrap
          sudo rsync -a work/bootstrap/{lib,etc,usr} work/rootfs/

      # --- OS kimliği ---
      - name: TrixieOs identity
        run: |
          sudo tee work/rootfs/etc/os-release <<EOF
          NAME="TrixieOs"
          ID=trixieos
          VERSION="1.0"
          PRETTY_NAME="TrixieOs"
          EOF

      # --- Kernel ---
      - name: Build Linux kernel
        run: |
          wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.8.tar.xz
          tar -xf linux-6.6.8.tar.xz
          cd linux-6.6.8
          make defconfig
          make -j$(nproc)
          sudo make INSTALL_MOD_PATH=../work/rootfs modules_install
          sudo cp arch/x86/boot/bzImage ../work/iso/boot/vmlinuz

      # --- Init ---
      - name: Minimal init
        run: |
          sudo tee work/rootfs/init <<'EOF'
          #!/bin/sh
          mount -t proc proc /proc
          mount -t sysfs sys /sys
          mount -t devtmpfs dev /dev
          echo "TrixieOs ProjectA tarafından yapıldı"
          exec /bin/sh
          EOF
          sudo chmod +x work/rootfs/init

      # --- GitHub Repo Paket Sistemi ---
      - name: GitHub package fetcher
        run: |
          sudo tee work/rootfs/usr/bin/trx <<'EOF'
          #!/bin/sh
          NAME="$1"
          echo "Searching GitHub for $NAME..."
          URL=$(curl -s "https://api.github.com/search/code?q=$NAME+extension:tar.xz" \
            | grep browser_download_url | head -n1 | cut -d '"' -f4)
          [ -z "$URL" ] && echo "Not found" && exit 1
          wget "$URL" -O /tmp/pkg.tar.xz
          tar -xf /tmp/pkg.tar.xz -C /
          EOF
          sudo chmod +x work/rootfs/usr/bin/trx

      # --- Initramfs ---
      - name: Build initramfs
        run: |
          cd work/rootfs
          sudo find . | sudo cpio -o -H newc | gzip > ../iso/boot/initramfs.gz

      # --- GRUB ---
      - name: GRUB config
        run: |
          tee work/iso/boot/grub/grub.cfg <<EOF
          set timeout=0
          menuentry "TrixieOs" {
            linux /boot/vmlinuz
            initrd /boot/initramfs.gz
          }
          EOF

      # --- ISO ---
      - name: Build ISO
        run: |
          grub-mkrescue -o TrixieOs.iso work/iso

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: TrixieOs-ISO
          path: TrixieOs.iso
