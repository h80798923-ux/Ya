name: Build TrixieOs ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Install host deps
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex \
          libncurses-dev libssl-dev libelf-dev \
          grub-pc-bin grub-common xorriso mtools \
          squashfs-tools wget rsync sudo curl jq \
          python3 python3-gi python3-gi-cairo gir1.2-gtk-3.0

    - name: Prepare dirs
      run: mkdir -p work/{rootfs,iso/boot}

    # ---------- BOOTSTRAP (GİZLİ) ----------
    - name: Bootstrap base
      run: |
        wget -q https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86_64/alpine-minirootfs-3.23.2-x86_64.tar.gz
        sudo tar -xzf alpine-minirootfs-3.23.2-x86_64.tar.gz -C work/rootfs

    - name: Set identity
      run: |
        sudo tee work/rootfs/etc/os-release > /dev/null <<'EOF'
        NAME="TrixieOs"
        ID=trixieos
        PRETTY_NAME="TrixieOs"
        EOF
        echo "TrixieOs ProjectA tarafından yapıldı" | sudo tee work/rootfs/etc/issue

    # ---------- KERNEL ----------
    - name: Build kernel
      run: |
        cd work
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.8.tar.xz
        tar -xf linux-6.6.8.tar.xz
        cd linux-6.6.8
        make defconfig
        make -j$(nproc)
        sudo make modules_install INSTALL_MOD_PATH=../rootfs
        sudo cp arch/x86/boot/bzImage ../iso/boot/vmlinuz

    # ---------- SİSTEM + GUI ----------
    - name: System setup
      run: |
        sudo chroot work/rootfs /bin/sh <<'EOF'
        set -e

        adduser -D trixieuser
        echo "trixieuser:trixie" | chpasswd
        echo "%wheel ALL=(ALL) ALL" >> /etc/sudoers
        adduser trixieuser wheel

        apk add --no-cache \
          xfce4 xfce4-terminal \
          xorg-server xinit \
          lightdm lightdm-gtk-greeter \
          networkmanager dbus udev \
          sudo curl jq \
          python3 py3-gobject gtk+3.0

        rc-update add dbus default
        rc-update add NetworkManager default
        rc-update add lightdm default
        EOF

    # ---------- TRX CORE ----------
    - name: TRX core
      run: |
        sudo tee work/rootfs/usr/bin/trx > /dev/null <<'EOF'
        #!/bin/sh
        set -e

        DB="/var/lib/trx/db"
        CACHE="/var/lib/trx/cache"
        mkdir -p "$DB" "$CACHE"

        cmd="$1"
        pkg="$2"

        [ "$cmd" = "install" ] || exit 1

        repo=$(curl -s "https://api.github.com/search/repositories?q=$pkg+tar.gz+OR+tar.xz+OR+txz+OR+tgz" \
          | jq -r '.items[0].full_name')

        url=$(curl -s "https://api.github.com/repos/$repo/releases/latest" \
          | jq -r '.assets[].browser_download_url' \
          | grep -E '\.(tar\.gz|tar\.xz|txz|tgz)' | head -n1)

        file="$CACHE/$(basename "$url")"
        curl -L "$url" -o "$file"
        tar -xf "$file" -C /
        echo "$pkg" >> "$DB/installed"
        EOF
        sudo chmod +x work/rootfs/usr/bin/trx

    # ---------- TRX GUI ----------
    - name: TRX GUI App
      run: |
        sudo tee work/rootfs/usr/bin/trx-gui > /dev/null <<'EOF'
        #!/usr/bin/env python3
        import gi, subprocess
        gi.require_version("Gtk", "3.0")
        from gi.repository import Gtk

        def install(btn):
            pkg = entry.get_text().strip()
            if pkg:
                subprocess.Popen(["pkexec", "trx", "install", pkg])

        win = Gtk.Window(title="TRX App Store")
        win.set_default_size(420, 160)

        box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
        box.set_margin_top(20)
        box.set_margin_bottom(20)
        box.set_margin_start(20)
        box.set_margin_end(20)

        entry = Gtk.Entry()
        entry.set_placeholder_text("Uygulama adi (GitHub)")

        btn = Gtk.Button(label="Yükle")
        btn.connect("clicked", install)

        box.pack_start(entry, False, False, 0)
        box.pack_start(btn, False, False, 0)

        win.add(box)
        win.connect("destroy", Gtk.main_quit)
        win.show_all()
        Gtk.main()
        EOF
        sudo chmod +x work/rootfs/usr/bin/trx-gui

    - name: Desktop entry
      run: |
        sudo tee work/rootfs/usr/share/applications/trx.desktop > /dev/null <<'EOF'
        [Desktop Entry]
        Name=TRX App Store
        Exec=trx-gui
        Icon=system-software-install
        Type=Application
        Categories=System;
        EOF

    # ---------- INITRAMFS ----------
    - name: Initramfs
      run: |
        cd work/rootfs
        find . | cpio -o -H newc | gzip > ../iso/boot/initramfs.img

    # ---------- GRUB ----------
    - name: GRUB
      run: |
        mkdir -p work/iso/boot/grub
        cat > work/iso/boot/grub/grub.cfg <<'EOF'
        set timeout=2
        menuentry "TrixieOs" {
          linux /boot/vmlinuz quiet
          initrd /boot/initramfs.img
        }
        EOF

    - name: Build ISO
      run: grub-mkrescue -o TrixieOs.iso work/iso

    - uses: actions/upload-artifact@v4
      with:
        name: TrixieOs
        path: TrixieOs.iso
