name: Build TrixieOs ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:

    - name: Checkout
      uses: actions/checkout@v4

    # =========================
    # DEPENDENCIES (TAM)
    # =========================
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex \
          libncurses-dev libssl-dev \
          grub-pc-bin grub-common xorriso \
          wget tar gzip cpio rsync xz-utils \
          bzip2 file

    # =========================
    # ROOTFS (BOOTSTRAP – GİZLİ)
    # =========================
    - name: Create rootfs
      run: |
        mkdir rootfs
        wget https://dl-cdn.alpinelinux.org/alpine/v3.19/releases/x86_64/alpine-minirootfs-3.19.1-x86_64.tar.gz
        sudo tar -xzf alpine-minirootfs-3.19.1-x86_64.tar.gz -C rootfs

        # altyapıyı gizle
        sudo mv rootfs/sbin/apk rootfs/sbin/.trx-core || true
        sudo rm -rf rootfs/etc/apk rootfs/lib/apk

    # =========================
    # TRX (PAKET YÖNETİCİSİ)
    # =========================
    - name: Create trx
      run: |
        sudo tee rootfs/usr/bin/trx > /dev/null << 'EOF'
        #!/bin/sh
        exec /sbin/.trx-core "$@"
        EOF
        sudo chmod +x rootfs/usr/bin/trx

    # =========================
    # OS RELEASE
    # =========================
    - name: Set os-release
      run: |
        sudo tee rootfs/etc/os-release > /dev/null << 'EOF'
        NAME="TrixieOs"
        ID=trixieos
        VERSION="1.0"
        PRETTY_NAME="TrixieOs Linux"
        EOF

    # =========================
    # BUSYBOX (HATASIZ)
    # =========================
    - name: Build BusyBox
      run: |
        wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
        tar -xjf busybox-1.36.1.tar.bz2
        cd busybox-1.36.1
        make defconfig
        make -j$(nproc)
        sudo make CONFIG_PREFIX=../rootfs install

        sudo ln -sf /bin/busybox rootfs/bin/sh
        sudo ln -sf /bin/busybox rootfs/init

    # =========================
    # KERNEL
    # =========================
    - name: Build kernel
      run: |
        wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.8.tar.xz
        tar -xf linux-6.6.8.tar.xz
        cd linux-6.6.8
        make defconfig
        scripts/config --enable BLK_DEV_INITRD
        scripts/config --enable DEVTMPFS
        scripts/config --enable DEVTMPFS_MOUNT
        make -j$(nproc)
        cp arch/x86/boot/bzImage ../vmlinuz

    # =========================
    # INIT
    # =========================
    - name: Init script
      run: |
        sudo tee rootfs/init > /dev/null << 'EOF'
        #!/bin/sh
        mount -t proc proc /proc
        mount -t sysfs sysfs /sys
        mount -t devtmpfs devtmpfs /dev
        echo "TrixieOs ProjectA tarafından yapıldı"
        exec /bin/sh
        EOF
        sudo chmod +x rootfs/init

    # =========================
    # INITRAMFS
    # =========================
    - name: Build initramfs
      run: |
        cd rootfs
        sudo find . -print0 | sudo cpio --null -ov --format=newc | gzip > ../initramfs.img

    # =========================
    # ISO
    # =========================
    - name: Build ISO
      run: |
        mkdir -p iso/boot/grub
        cp vmlinuz iso/boot/vmlinuz
        cp initramfs.img iso/boot/initramfs.img

        cat > iso/boot/grub/grub.cfg << 'EOF'
        set timeout=5
        menuentry "TrixieOs" {
          linux /boot/vmlinuz init=/init
          initrd /boot/initramfs.img
        }
        EOF

        grub-mkrescue -o TrixieOs.iso iso

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: TrixieOs-ISO
        path: TrixieOs.iso
