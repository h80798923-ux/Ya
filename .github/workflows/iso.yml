name: Build TrixieOs ISO (robust-final)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    env:
      MAKEFLAGS: "-j1"

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies (complete)
      run: |
        set -euo pipefail
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex \
          libncurses-dev libssl-dev libelf-dev libdw-dev binutils-dev \
          wget tar gzip xz-utils bzip2 cpio rsync file \
          xorriso grub-pc-bin grub-common mtools pkg-config

    - name: Prepare workspace
      run: |
        set -euo pipefail
        rm -rf rootfs iso vmlinuz initrd.img initramfs.img initrd.img TrixieOs.iso
        mkdir -p rootfs iso/boot/grub rootfs/boot rootfs/bin rootfs/sbin rootfs/usr/bin

    # ---------------- ROOTFS (bootstrap - visible download for debugging) ----------------
    - name: Bootstrap base rootfs (hidden)
      run: |
        set -euo pipefail
        wget https://dl-cdn.alpinelinux.org/alpine/v3.19/releases/x86_64/alpine-minirootfs-3.19.1-x86_64.tar.gz
        sudo tar -xzf alpine-minirootfs-3.19.1-x86_64.tar.gz -C rootfs

        # ensure we own files to avoid permission denied
        sudo chown -R $USER:$USER rootfs

        # cleanup locks and visible alpine traces
        sudo rm -f rootfs/etc/alpine-release || true
        sudo rm -f rootfs/lib/apk/db/lock || true
        sudo rm -rf rootfs/etc/apk || true

    # ---------------- OS IDENTITY ----------------
    - name: Set /etc/os-release and banners
      run: |
        set -euo pipefail
        cat > rootfs/etc/os-release <<'EOF'
        NAME="TrixieOs"
        ID=trixieos
        PRETTY_NAME="TrixieOs"
        VERSION="1.0"
        VERSION_ID="1.0"
        HOME_URL="https://trixieos.local"
        EOF
        echo "TrixieOs ProjectA tarafından yapıldı" > rootfs/etc/issue
        echo "Welcome to TrixieOs" > rootfs/etc/motd

    # ---------------- TRX wrapper ----------------
    - name: Create trx wrapper and ensure apk forwarding (safe)
      run: |
        set -euo pipefail
        if [ -f rootfs/sbin/apk ]; then
          sudo mv rootfs/sbin/apk rootfs/sbin/.apk.real || true
        fi

        cat > rootfs/usr/bin/trx <<'EOF'
        #!/bin/sh
        exec /sbin/.apk.real "$@"
        EOF
        sudo chmod +x rootfs/usr/bin/trx || true

        # provide an apk shim that forwards to trx if present
        cat > rootfs/sbin/apk <<'EOF'
        #!/bin/sh
        exec /usr/bin/trx "$@"
        EOF
        sudo chmod +x rootfs/sbin/apk || true

    # ---------------- BUSYBOX (single-threaded, warnings suppressed safely) ----------------
    - name: Build BusyBox (safe)
      run: |
        set -euo pipefail
        # don't use -q to ensure output appears in logs
        wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
        tar -xjf busybox-1.36.1.tar.bz2
        cd busybox-1.36.1

        # default config
        make defconfig

        # disable heavier or CI-problematic features
        sed -i 's/CONFIG_I2C_TOOLS=y/CONFIG_I2C_TOOLS=n/' .config || true
        sed -i 's/CONFIG_IFUPDOWN=y/CONFIG_IFUPDOWN=n/' .config || true
        sed -i 's/CONFIG_FEATURE_IFCONFIG_STATUS=y/CONFIG_FEATURE_IFCONFIG_STATUS=n/' .config || true

        # compile single-threaded to avoid runner resource spike
        make -j1 CFLAGS="-O2 -Wno-format-truncation" V=0

        # install into rootfs
        sudo make CONFIG_PREFIX=../rootfs install

        # ensure sh and init point to busybox
        sudo ln -sf /bin/busybox rootfs/bin/sh
        sudo ln -sf /bin/busybox rootfs/init
        sudo chmod +x rootfs/init

    # ---------------- KERNEL (conservative, single-threaded) ----------------
    - name: Build Linux kernel (safe)
      run: |
        set -euo pipefail
        wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.8.tar.xz
        tar -xf linux-6.6.8.tar.xz
        cd linux-6.6.8

        # baseline config
        make defconfig

        # enable essential runtime options to prevent panics
        scripts/config --enable BLK_DEV_INITRD || true
        scripts/config --enable DEVTMPFS || true
        scripts/config --enable DEVTMPFS_MOUNT || true
        scripts/config --enable TMPFS || true
        scripts/config --disable DEBUG_INFO || true

        # refresh config
        make olddefconfig

        # reduce resource usage: single-threaded
        make -j1

        # copy kernel image
        sudo cp arch/x86/boot/bzImage ../vmlinuz

    # ---------------- INIT ----------------
    - name: Ensure robust init
      run: |
        set -euo pipefail
        cat > rootfs/init <<'EOF'
        #!/bin/sh
        mount -t proc proc /proc || true
        mount -t sysfs sysfs /sys || true
        mount -t devtmpfs devtmpfs /dev || true
        echo "TrixieOs ProjectA tarafından yapıldı"
        echo "Paket yöneticisi: trx"
        exec /bin/sh
        EOF
        sudo chmod +x rootfs/init
        sudo chown root:root rootfs/init

    # ---------------- CLEANUP (locks & perms) ----------------
    - name: Cleanup locks & permissions
      run: |
        set -euo pipefail
        sudo rm -f rootfs/lib/apk/db/lock || true
        sudo chmod -R u+rwX rootfs || true

    # ---------------- BUILD INITRAMFS ----------------
    - name: Build initramfs (robust)
      run: |
        set -euo pipefail
        cd rootfs
        sudo find . -print0 | sudo cpio --null -ov --format=newc --owner=root:root | gzip > ../initrd.img
        sudo chown $USER:$USER ../initrd.img || true

    # ---------------- PREPARE ISO TREE ----------------
    - name: Prepare ISO tree & grub config
      run: |
        set -euo pipefail
        mkdir -p iso/boot/grub
        cp vmlinuz iso/boot/vmlinuz
        cp initrd.img iso/boot/initrd.img

        cat > iso/boot/grub/grub.cfg <<'EOF'
        set timeout=5
        set default=0

        menuentry "TrixieOs" {
          echo "TrixieOs ProjectA tarafından yapıldı"
          linux /boot/vmlinuz init=/init
          initrd /boot/initrd.img
        }
        EOF

    # ---------------- BUILD ISO (xorriso/mtools safe) ----------------
    - name: Build bootable ISO (final)
      run: |
        set -euo pipefail
        sudo rm -f rootfs/lib/apk/db/lock || true
        sudo chmod -R u+rwX rootfs || true

        # produce ISO and if fail, dump last logs to help debugging
        if ! grub-mkrescue -o TrixieOs.iso iso ; then
          echo "grub-mkrescue failed — dumping last 200 lines of system logs"
          dmesg | tail -n 200 || true
          ls -lR iso | tail -n 200 || true
          exit 1
        fi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: TrixieOs-ISO
        path: TrixieOs.iso
