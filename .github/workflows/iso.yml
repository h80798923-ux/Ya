name: Build TrixieOs ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex \
          libncurses-dev libssl-dev \
          grub-pc-bin grub-common xorriso \
          wget tar gzip cpio rsync xz-utils

    # =========================
    # ROOTFS (BOOTSTRAP)
    # =========================
    - name: Create base rootfs
      run: |
        mkdir -p rootfs
        wget https://dl-cdn.alpinelinux.org/alpine/v3.19/releases/x86_64/alpine-minirootfs-3.19.1-x86_64.tar.gz
        sudo tar -xzf alpine-minirootfs-3.19.1-x86_64.tar.gz -C rootfs

        # GİZLE: apk altyapısı ama adı görünmeyecek
        sudo mv rootfs/sbin/apk rootfs/sbin/.apk.real || true

    # =========================
    # TRX (APK GİZLEME WRAPPER)
    # =========================
    - name: Create trx package manager
      run: |
        sudo tee rootfs/usr/bin/trx > /dev/null << 'EOF'
        #!/bin/sh
        exec /sbin/.apk.real "$@"
        EOF
        sudo chmod +x rootfs/usr/bin/trx

        # apk kelimesini tamamen gizle
        sudo rm -rf rootfs/etc/apk
        sudo rm -rf rootfs/lib/apk

    # =========================
    # OS RELEASE
    # =========================
    - name: Set os-release to TrixieOs
      run: |
        sudo tee rootfs/etc/os-release > /dev/null << 'EOF'
        NAME="TrixieOs"
        ID=trixieos
        VERSION="1.0"
        PRETTY_NAME="TrixieOs Linux"
        HOME_URL="https://trixieos.local"
        SUPPORT_URL="https://trixieos.local/support"
        EOF

    # =========================
    # BUSYBOX (DERLENİR)
    # =========================
    - name: Build BusyBox
      run: |
        wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
        tar xf busybox-1.36.1.tar.bz2
        cd busybox-1.36.1
        make defconfig
        make -j$(nproc)
        sudo make CONFIG_PREFIX=../rootfs install

        sudo ln -sf /bin/busybox rootfs/bin/sh
        sudo ln -sf /bin/busybox rootfs/init

    # =========================
    # KERNEL (DERLENİR)
    # =========================
    - name: Build Linux kernel
      run: |
        wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.8.tar.xz
        tar xf linux-6.6.8.tar.xz
        cd linux-6.6.8

        make defconfig
        scripts/config --enable BLK_DEV_INITRD
        scripts/config --enable DEVTMPFS
        scripts/config --enable DEVTMPFS_MOUNT
        scripts/config --enable TMPFS

        make -j$(nproc)
        cp arch/x86/boot/bzImage ../vmlinuz

    # =========================
    # INIT
    # =========================
    - name: Create init
      run: |
        sudo tee rootfs/init > /dev/null << 'EOF'
        #!/bin/sh
        mount -t proc proc /proc
        mount -t sysfs sysfs /sys
        mount -t devtmpfs devtmpfs /dev
        echo "TrixieOs ProjectA tarafından yapıldı"
        exec /bin/sh
        EOF
        sudo chmod +x rootfs/init

    # =========================
    # INITRAMFS
    # =========================
    - name: Build initramfs
      run: |
        cd rootfs
        sudo find . | sudo cpio -H newc -o | gzip > ../initramfs.img

    # =========================
    # ISO
    # =========================
    - name: Build ISO
      run: |
        mkdir -p iso/boot/grub
        cp vmlinuz iso/boot/vmlinuz
        cp initramfs.img iso/boot/initramfs.img

        cat > iso/boot/grub/grub.cfg << 'EOF'
        set timeout=5
        set default=0

        menuentry "TrixieOs Linux" {
          linux /boot/vmlinuz init=/init
          initrd /boot/initramfs.img
        }
        EOF

        grub-mkrescue -o TrixieOs.iso iso

    # =========================
    # UPLOAD
    # =========================
    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: TrixieOs-ISO
        path: TrixieOs.iso
