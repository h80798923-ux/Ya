name: Build TrixieOs ISO (kernel build)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install host dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex \
          libncurses-dev libssl-dev libelf-dev \
          wget curl tar xz-utils \
          squashfs-tools \
          grub-pc-bin grub-efi-amd64-bin \
          xorriso mtools \
          rsync

    - name: Prepare directories
      run: |
        mkdir -p work/rootfs iso/boot/grub work/kernel

    # --------------------------------------------------
    # Alpine bootstrap (HIDDEN, ONLY BASE FILES)
    # --------------------------------------------------
    - name: Alpine bootstrap
      run: |
        wget -O alpine.tar.gz \
        https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86_64/alpine-minirootfs-3.23.2-x86_64.tar.gz
        sudo tar -xzf alpine.tar.gz -C work/rootfs

    - name: Fix DNS and apk repo
      run: |
        sudo cp /etc/resolv.conf work/rootfs/etc/resolv.conf
        sudo tee work/rootfs/etc/apk/repositories > /dev/null <<'EOF'
        https://dl-cdn.alpinelinux.org/alpine/v3.23/main
        https://dl-cdn.alpinelinux.org/alpine/v3.23/community
        EOF

    # --------------------------------------------------
    # BUILD LINUX KERNEL
    # --------------------------------------------------
    - name: Download and build Linux kernel
      run: |
        cd work/kernel
        wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.9.tar.xz
        tar -xf linux-6.6.9.tar.xz
        cd linux-6.6.9

        make defconfig
        make -j$(nproc)

        mkdir -p ../../iso/boot
        cp arch/x86/boot/bzImage ../../iso/boot/vmlinuz

    # --------------------------------------------------
    # SYSTEM SETUP (NO BUSYBOX BUILD)
    # --------------------------------------------------
    - name: Configure system inside chroot
      run: |
        sudo chroot work/rootfs /bin/sh <<'EOF'
        set -e

        apk update

        apk add --no-cache \
          xfce4 xfce4-terminal \
          xorg-server xinit \
          lightdm lightdm-gtk-greeter \
          networkmanager dbus udev \
          sudo curl jq \
          python3 py3-gobject gtk+3.0 \
          elogind

        rc-update add dbus default
        rc-update add NetworkManager default
        rc-update add lightdm default

        adduser -D trixieuser
        echo "trixieuser:trixie" | chpasswd
        adduser trixieuser wheel
        echo "%wheel ALL=(ALL) ALL" >> /etc/sudoers

        echo "exec startxfce4" > /home/trixieuser/.xinitrc
        chown trixieuser:trixieuser /home/trixieuser/.xinitrc

        rm -f /lib/apk/db/lock
        rm -rf /var/cache/apk/*

        EOF

    # --------------------------------------------------
    # BRANDING
    # --------------------------------------------------
    - name: Branding TrixieOs
      run: |
        sudo tee work/rootfs/etc/os-release > /dev/null <<'EOF'
        NAME="TrixieOs"
        ID=trixieos
        VERSION="1.0"
        PRETTY_NAME="TrixieOs"
        EOF

        sudo tee work/rootfs/etc/issue > /dev/null <<'EOF'
        TrixieOs ProjectA tarafından yapıldı
        EOF

    # --------------------------------------------------
    # INITRAMFS
    # --------------------------------------------------
    - name: Create initramfs
      run: |
        cd work/rootfs
        sudo find . | sudo cpio -H newc -o | gzip > ../iso/boot/initrd.img

    # --------------------------------------------------
    # GRUB
    # --------------------------------------------------
    - name: Create GRUB config
      run: |
        cat > iso/boot/grub/grub.cfg <<'EOF'
        set timeout=3
        set default=0

        menuentry "TrixieOs" {
          linux /boot/vmlinuz quiet
          initrd /boot/initrd.img
        }
        EOF

    # --------------------------------------------------
    # ISO
    # --------------------------------------------------
    - name: Build ISO
      run: |
        grub-mkrescue -o TrixieOs.iso iso

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: TrixieOs
        path: TrixieOs.iso
